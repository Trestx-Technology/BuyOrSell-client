name: Simple Git Operations

on:
  workflow_dispatch:
    inputs:
      commit_message:
        description: "Commit message (optional - will auto-generate if empty)"
        required: false
        default: ""
      merge_strategy:
        description: "How to merge changes?"
        required: true
        default: "pr-to-dev"
        type: choice
        options:
          - pr-to-dev
          - direct-merge-dev

jobs:
  git-ops:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current branch
        id: current-branch
        run: echo "branch=$(git branch --show-current)" >> $GITHUB_OUTPUT

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Generate smart commit message
        id: commit-msg
        run: |
          if [ -n "${{ github.event.inputs.commit_message }}" ]; then
            echo "message=${{ github.event.inputs.commit_message }}" >> $GITHUB_OUTPUT
          else
            # Smart commit message generation based on file changes
            if git diff --name-only | grep -q "\.tsx\?$"; then
              if git diff --name-only | grep -q "animation\|motion"; then
                echo "message=feat: add smooth animations and motion effects" >> $GITHUB_OUTPUT
              elif git diff --name-only | grep -q "component\|ui"; then
                echo "message=feat: update UI components and styling" >> $GITHUB_OUTPUT
              else
                echo "message=feat: update React components" >> $GITHUB_OUTPUT
              fi
            elif git diff --name-only | grep -q "\.css$"; then
              echo "message=style: update CSS styling and animations" >> $GITHUB_OUTPUT
            elif git diff --name-only | grep -q "\.ts$" && git diff --name-only | grep -q "config"; then
              echo "message=chore: update configuration files" >> $GITHUB_OUTPUT
            elif git diff --name-only | grep -q "\.json$"; then
              echo "message=chore: update dependencies and config" >> $GITHUB_OUTPUT
            else
              echo "message=chore: update project files" >> $GITHUB_OUTPUT
            fi
          fi

      - name: 1. Add all changes
        run: git add .

      - name: 2. Commit changes
        run: |
          git commit -m "${{ steps.commit-msg.outputs.message }}"
        continue-on-error: true

      - name: 3. Pull latest changes from current branch
        run: |
          git pull origin ${{ steps.current-branch.outputs.branch }} --rebase
        continue-on-error: true

      - name: 4. Push to current branch
        run: |
          git push origin ${{ steps.current-branch.outputs.branch }}
        continue-on-error: true

      - name: 5A. Create PR to dev (if chosen)
        if: github.event.inputs.merge_strategy == 'pr-to-dev'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: dev
          branch: ${{ steps.current-branch.outputs.branch }}
          title: "ğŸ”„ Auto PR: ${{ steps.commit-msg.outputs.message }}"
          body: |
            ## ğŸš€ Auto-generated Pull Request to dev

            This PR was automatically created after your recent changes.

            **ğŸ“ Commit Message:** `${{ steps.commit-msg.outputs.message }}`

            **ğŸ“ Changed Files:**
            $(git diff --name-only | sed 's/^/- `/' | sed 's/$/`/')

            **âœ… Ready to merge into dev!**

            ---
            *ğŸ¤– Auto-generated by GitHub Actions*
          labels: |
            auto-generated
            ready-to-merge
          draft: false

      - name: 5B. Direct merge to dev (if chosen)
        if: github.event.inputs.merge_strategy == 'direct-merge-dev'
        run: |
          # Checkout dev branch
          git checkout dev
          git pull origin dev

          # Merge current branch into dev
          git merge ${{ steps.current-branch.outputs.branch }} --no-ff -m "Merge ${{ steps.current-branch.outputs.branch }}: ${{ steps.commit-msg.outputs.message }}"

          # Push to dev
          git push origin dev

          echo "âœ… Successfully merged ${{ steps.current-branch.outputs.branch }} into dev"
        continue-on-error: true
