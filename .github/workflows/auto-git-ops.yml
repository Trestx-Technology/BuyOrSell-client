name: Auto Git Operations

on:
  workflow_dispatch:
    inputs:
      commit_message:
        description: "Custom commit message (optional)"
        required: false
        default: ""
      target_branch:
        description: "Target branch to push to"
        required: false
        default: "dev"
  push:
    branches: [dev, main]
    paths-ignore:
      - "**.md"
      - ".github/**"

jobs:
  git-operations:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Generate commit message
        id: commit-msg
        run: |
          if [ -n "${{ github.event.inputs.commit_message }}" ]; then
            echo "message=${{ github.event.inputs.commit_message }}" >> $GITHUB_OUTPUT
          else
            # Generate automatic commit message based on changes
            if git diff --cached --name-only | grep -q "\.tsx\?$"; then
              echo "message=feat: update React components and UI improvements" >> $GITHUB_OUTPUT
            elif git diff --cached --name-only | grep -q "\.css$"; then
              echo "message=style: update styling and animations" >> $GITHUB_OUTPUT
            elif git diff --cached --name-only | grep -q "\.ts$"; then
              echo "message=feat: update configuration and utilities" >> $GITHUB_OUTPUT
            elif git diff --cached --name-only | grep -q "\.json$"; then
              echo "message=chore: update dependencies and configuration" >> $GITHUB_OUTPUT
            else
              echo "message=chore: update project files" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Add all changes
        run: git add .

      - name: Commit changes
        run: |
          git commit -m "${{ steps.commit-msg.outputs.message }}

          Auto-committed by GitHub Actions
          Changes: $(git diff --cached --name-only | head -5 | tr '\n' ' ')"
        continue-on-error: true

      - name: Pull latest changes
        run: |
          git pull origin ${{ github.event.inputs.target_branch || 'dev' }} --rebase
        continue-on-error: true

      - name: Push changes
        run: |
          git push origin ${{ github.event.inputs.target_branch || 'dev' }}
        continue-on-error: true

      - name: Create Pull Request (if pushing to dev)
        if: github.event.inputs.target_branch == 'dev' || github.event.inputs.target_branch == ''
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: auto-pr-${{ github.run_number }}
          title: "Auto PR: ${{ steps.commit-msg.outputs.message }}"
          body: |
            ## Auto-generated Pull Request

            This PR was automatically created by GitHub Actions after committing changes.

            **Commit Message:** ${{ steps.commit-msg.outputs.message }}

            **Changes Include:**
            - $(git diff --cached --name-only | head -10 | sed 's/^/- /')

            Please review and merge if everything looks good!

            ---
            *Auto-generated by GitHub Actions*
          labels: |
            auto-generated
            needs-review
          draft: false
