name: Deploy client Panel to EC2 (Development)

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build Next.js app
        env:
          # Build flags
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: "1"
        run: yarn build

      - name: Create deployment package
        run: |
          # Clean up Next.js build cache to reduce package size
          rm -rf .next/cache || true

          mkdir deploy-package
          cp -r .next deploy-package/
          cp -r public deploy-package/
          cp package.json deploy-package/
          cp yarn.lock deploy-package/
          cp ecosystem.config.js deploy-package/ 2>/dev/null || true
          cp next.config.js deploy-package/ 2>/dev/null || true
          cp next.config.ts deploy-package/ 2>/dev/null || true

          # Create compressed archive excluding maps and any cache directories
          tar -czf release.tgz \
            --exclude=".next/cache" \
            --exclude="**/*.map" \
            -C deploy-package .

      - name: Verify package size (< 1 GB)
        run: |
          BYTES=$(stat -c%s "release.tgz" 2>/dev/null || stat -f%z "release.tgz")
          echo "release.tgz size: $BYTES bytes"
          if [ "$BYTES" -ge 1073741824 ]; then
            echo "Error: release.tgz exceeds 1 GB limit" >&2
            exit 1
          fi

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          if [ -n "${{ secrets.EC2_SSH_KEY_BASE64 }}" ]; then
            echo "${{ secrets.EC2_SSH_KEY_BASE64 }}" | base64 -d > ~/.ssh/id_rsa
          else
            KEY="${{ secrets.EC2_SSH_KEY }}"
            printf "%b" "$KEY" | tr -d '\r' > ~/.ssh/id_rsa
          fi
          chmod 600 ~/.ssh/id_rsa

          HOST="${{ secrets.EC2_DEVELOPMENT_HOST }}"
          USER="${{ secrets.EC2_USER }}"
          if [ -z "$USER" ]; then USER="${{ vars.EC2_USER }}"; fi
          if [ -z "$USER" ]; then USER="ubuntu"; fi
          PORT="${{ secrets.EC2_SSH_PORT }}"
          if [ -z "$PORT" ]; then PORT="22"; fi

          if [ -n "$HOST" ]; then
            ssh-keyscan -p "$PORT" -H "$HOST" >> ~/.ssh/known_hosts 2>/dev/null || echo "ssh-keyscan failed (non-fatal), continuing..."
          fi

      - name: Deploy to EC2
        run: |
          HOST="${{ secrets.EC2_DEVELOPMENT_HOST }}"
          USER="${{ secrets.EC2_USER }}"
          if [ -z "$USER" ]; then USER="${{ vars.EC2_USER }}"; fi
          if [ -z "$USER" ]; then USER="ubuntu"; fi
          PORT="${{ secrets.EC2_SSH_PORT }}"
          if [ -z "$PORT" ]; then PORT="22"; fi

          # Upload build package
          scp -i ~/.ssh/id_rsa -P "$PORT" -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null release.tgz "$USER@$HOST:/tmp/"

          # SSH into EC2 and deploy
          ssh -i ~/.ssh/id_rsa -p "$PORT" -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$USER@$HOST" << 'EOF'
            set -e
            cd ~/client-panel-dev || { mkdir -p ~/client-panel-dev; cd ~/client-panel-dev; }

            # Stop and remove old app
            pm2 delete client-dev || true

            # Remove previous deployment
            rm -rf ~/client-panel-dev/*

            # Extract new deployment
            tar -xzf /tmp/release.tgz -C ~/client-panel-dev

            # Install dependencies
            yarn install --production --frozen-lockfile

            # Start app under PM2
            pm2 start yarn --name "client-dev" -- start
            pm2 save

            # Clean up
            rm -f /tmp/release.tgz
          EOF
