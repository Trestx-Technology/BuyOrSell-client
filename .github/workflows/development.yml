name: Deploy client Panel to EC2 (Development)

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build Next.js app
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          NEXT_PUBLIC_GOOGLE_MAP_KEY: ${{ vars.NEXT_PUBLIC_GOOGLE_MAP_KEY }}
          NEXT_PUBLIC_BACKEND_URL: ${{ vars.NEXT_PUBLIC_BACKEND_URL }}
          # Build flags
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: "1"
        run: yarn build

      - name: Create deployment package
        run: |
          # Clean up Next.js build cache to reduce package size
          rm -rf .next/cache || true

          mkdir deploy-package
          cp -r .next deploy-package/
          cp -r public deploy-package/
          cp package.json deploy-package/
          cp yarn.lock deploy-package/
          cp ecosystem.config.js deploy-package/ 2>/dev/null || true
          cp next.config.js deploy-package/ 2>/dev/null || true
          cp next.config.ts deploy-package/ 2>/dev/null || true

          # Create compressed archive excluding maps and any cache directories
          tar -czf release.tgz \
            --exclude=".next/cache" \
            --exclude="**/*.map" \
            -C deploy-package .

      - name: Verify package size (< 1 GB)
        run: |
          BYTES=$(stat -c%s "release.tgz" 2>/dev/null || stat -f%z "release.tgz")
          echo "release.tgz size: $BYTES bytes"
          if [ "$BYTES" -ge 1073741824 ]; then
            echo "Error: release.tgz exceeds 1 GB limit" >&2
            exit 1
          fi

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          if [ -n "${{ secrets.EC2_SSH_KEY_BASE64 }}" ]; then
            echo "${{ secrets.EC2_SSH_KEY_BASE64 }}" | base64 -d > ~/.ssh/id_rsa
          else
            KEY="${{ secrets.EC2_SSH_KEY }}"
            printf "%b" "$KEY" | tr -d '\r' > ~/.ssh/id_rsa
          fi
          chmod 600 ~/.ssh/id_rsa

          HOST="${{ secrets.EC2_DEVELOPMENT_HOST }}"
          USER="${{ secrets.EC2_USER }}"
          if [ -z "$USER" ]; then USER="${{ secrets.EC2_USER }}"; fi
          if [ -z "$USER" ]; then USER="ubuntu"; fi
          PORT="${{ secrets.EC2_SSH_PORT }}"
          if [ -z "$PORT" ]; then PORT="22"; fi

          if [ -n "$HOST" ]; then
            ssh-keyscan -p "$PORT" -H "$HOST" >> ~/.ssh/known_hosts 2>/dev/null || echo "ssh-keyscan failed (non-fatal), continuing..."
          fi

      - name: Deploy to EC2
        run: |
          HOST="${{ secrets.EC2_DEVELOPMENT_HOST }}"
          USER="${{ secrets.EC2_USER }}"
          if [ -z "$USER" ]; then USER="${{ secrets.EC2_USER }}"; fi
          if [ -z "$USER" ]; then USER="ubuntu"; fi
          PORT="${{ secrets.EC2_SSH_PORT }}"
          if [ -z "$PORT" ]; then PORT="22"; fi

          # Upload build package
          scp -i ~/.ssh/id_rsa -P "$PORT" -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null release.tgz "$USER@$HOST:/tmp/"

          # SSH into EC2 and deploy
          ssh -i ~/.ssh/id_rsa -p "$PORT" -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$USER@$HOST" << 'EOF'
            set -e
            
            # Create directory if it doesn't exist
            mkdir -p ~/client-panel-dev
            cd ~/client-panel-dev

            # Install Node.js if not present
            if ! command -v node >/dev/null 2>&1; then
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            # Install Yarn if not present
            if ! command -v yarn >/dev/null 2>&1; then
              curl -fsSL https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
              echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
              sudo apt update
              sudo apt install yarn -y
            fi

            # Install PM2 if not present
            if ! command -v pm2 >/dev/null 2>&1; then
              sudo npm install -g pm2
            fi

            # Stop and remove old app
            pm2 delete client-dev || true

            # Remove previous deployment
            rm -rf ~/client-panel-dev/*

            # Extract new deployment
            tar -xzf /tmp/release.tgz -C ~/client-panel-dev

            # Install dependencies
            yarn install --production --frozen-lockfile

            # Ensure the app is built (should already be built from CI)
            if [ ! -d ".next" ]; then
              echo "Error: .next directory not found. Build the app first."
              exit 1
            fi

            # Verify Next.js binary exists
            if [ ! -f "node_modules/.bin/next" ]; then
              echo "Error: Next.js binary not found. Dependencies may not be installed correctly."
              exit 1
            fi

            # Stop and remove old app if exists
            pm2 delete client-dev || true

            # Start app under PM2
            pm2 start ecosystem.config.js --env development
            pm2 save

           

            # Clean up
            rm -f /tmp/release.tgz
          EOF
